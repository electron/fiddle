version: 2.1

orbs:
  github: circleci/github-cli@2.2.0
  node: circleci/node@5.1.0
  win: circleci/windows@5.0.0

commands:
  install:
    steps:
      - run: git config --global core.autocrlf input
      - node/install:
          node-version: '18.4.0'
      - run: nvm use 18.4.0
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ arch }}-{{ checksum "yarn.lock" }}
            - v1-dependencies-{{ arch }}
      - run: npm install --global yarn
      - run: yarn install --frozen-lockfile
      - run: yarn run lint
      - save_cache:
          paths:
            - node_modules
          key: v1-dependencies-{{ arch }}-{{ checksum "yarn.lock" }}

jobs:
  mac-build:
    parameters:
      arch:
        type: enum
        enum: [ 'x64', 'arm64' ]
    macos:
      xcode: '13.4.0'
    resource_class: macos.x86.medium.gen2
    steps:
      - install
      - run: yarn test:ci
      - run: chmod +x tools/add-macos-cert.sh && ./tools/add-macos-cert.sh
        # MACOS_CERT_P12, MACOS_CERT_PASSWORD
      - run: npx yarn make --arch=<< parameters.arch >>
      - store_artifacts:
          path: out/*
  win-build:
    parameters:
      arch:
        type: enum
        enum: [ 'x64', 'arm64', 'ia32' ]
    executor:
      name: win/default
      shell: bash.exe
    steps:
      - install
      - run: yarn test:ci
      - run: export WINDOWS_CODESIGN_FILE=$(node add-windows-cert.js)
      - run: npx yarn make --arch=<< parameters.arch >>
      # APPLE_ID, APPLE_ID_PASSWORD, GITHUB_TOKEN, WINDOWS_CODESIGN_FILE, WINDOWS_CODESIGN_PASSWORD
      - store_artifacts:
          path: out/*
  linux-build:
    parameters:
      arch:
        type: enum
        enum: [ 'x64', 'arm64','armv7l' ]
    docker:
      - image: cimg/base:stable
    steps:
      - run: sudo apt-get update && sudo apt install rpm
      - install
      - run: yarn test:ci
      - run: npx yarn make --arch=<< parameters.arch >>
      - store_artifacts:
          path: out/*

workflows:
  build-and-release:
    jobs:
      - mac-build:
          matrix:
            parameters:
              arch: [ x64, arm64 ]
      - win-build:
          matrix:
            parameters:
              arch: [ x64, ia32 ]
      - linux-build:
          matrix:
            parameters:
              arch: [ x64, arm64, armv7l ]
      # - github/release:
      #     context:
      #       - GITHUB_TOKEN
      #     filters:
      #       tags:
      #         only:
      #           - /^v[0-9]+(\.[0-9]+)*$/
      #     requires:
      #       - mac-build
      #       - win-build
      #       - linux-build
      #     tag: << pipeline.git.tag >>
      #     title: << pipeline.git.tag >>
      #     draft: true
      #     files: |
      #       out/**/*.deb
      #       out/**/*.dmg
      #       out/**/*setup*.exe
      #       out/**/*.nupkg
      #       out/**/*.rpm
      #       out/**/*.zip
      #       out/**/RELEASES
